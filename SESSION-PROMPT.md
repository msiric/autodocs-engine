# Session Prompt — Deterministic Template Implementation

Open a new Claude Code session from: `/Users/mariosiric/Documents/autodocs-engine/`

Then paste everything between the triple-backtick block below.

---

```
# autodocs-engine — Deterministic Template Generation

The engine's JSON analysis is accurate but the LLM formatting layer hallucinates. The fix: generate 13 of 15 AGENTS.md sections deterministically in code. Use the LLM only for 2 sections that genuinely need synthesis (architecture capabilities + domain terminology).

## Before You Code

Read the complete plan:
`docs/DETERMINISTIC-PLAN.md`

It has 8 implementation steps with exact code, types, and functions for each section.

Key principle: **The LLM receives ONLY the specific data for the section it's synthesizing. It never sees the full analysis. It can't hallucinate React because it never sees import data that might mention React.**

## What to Build

### The Core Change

**Current:** ALL sections generated by LLM from serialized analysis (hallucinations in 70% of output)
**New:** 13 sections generated in code from verified data (zero hallucination possible), 2 sections via micro-LLM calls with constrained inputs

### New Module: `src/deterministic-formatter.ts` (~300 lines)

Generate these sections deterministically:
1. **Title** — from `pkg.name`
2. **Summary** — from `pkg.role.summary`
3. **Tech Stack** — from `dependencyInsights.frameworks` + `configAnalysis` (join with " | ")
4. **Commands** — from `pkg.commands` + workspace commands (markdown table)
5. **Package Guide** — from `role.whenToUse` per package (markdown table, multi-package only)
6. **Workflow Rules** — from `workflowRules` + high-impact conventions
7. **How to Add New Code** — from `contributionPatterns`
8. **Public API** — from `publicAPI` grouped by kind
9. **Dependencies** — from `dependencies` (internal + top external)
10. **Conventions** — from `conventions` + `antiPatterns` as DO/DON'T
11. **Dependency Graph** — from `crossPackage.dependencyGraph`
12. **Mermaid Diagram** — from `crossPackage.mermaidDiagram`
13. **Team Knowledge** — static placeholder

The formatting logic already exists in `src/llm/serializer.ts`. Adapt it from "serialize for LLM input" to "format as AGENTS.md output" — table formats, grouped lists, DO/DON'T directives.

### README Extraction: Extend `src/existing-docs.ts` (~40 lines)

Read the first paragraph of README.md (after title/badges) for domain context. Return up to 500 characters.

### Micro-LLM Calls: In `src/llm/adapter.ts` (~100 lines)

Two tiny, constrained LLM calls:

1. **Architecture synthesis:** Input is ONLY directory names + export names + call graph edges. No framework names, no imports. Prompt: "Write 4-6 bullets describing capabilities. Do NOT mention any technology by name." Max 500 tokens.

2. **Domain terminology:** Input is ONLY the README first paragraph. Prompt: "Extract 3-5 domain terms with definitions." Max 300 tokens.

Both have fallbacks if no API key or LLM fails.

### Assembly: Combine deterministic + LLM sections into final AGENTS.md

### CLI Flag: `--llm-synthesis`
- `deterministic` (DEFAULT): new approach
- `full`: old full-LLM approach (backward compatible)

### Hierarchical: Extend to use deterministic formatter for root + per-package files

## Implementation Order

1. `src/deterministic-formatter.ts` — all 13 section formatting functions + assembly
2. Extend `src/existing-docs.ts` — `extractReadmeContext()` function
3. `src/llm/adapter.ts` — `formatDeterministic()`, `synthesizeArchitecture()`, `synthesizeDomainTerms()`
4. `src/llm/hierarchical.ts` — deterministic hierarchical output
5. `src/config.ts` + `src/bin/autodocs-engine.ts` — `--llm-synthesis` flag
6. Tests — `test/deterministic-formatter.test.ts`

## Testing

### Preserved benchmark repos at /tmp/final-benchmark/

After implementation:
```bash
export ANTHROPIC_API_KEY=$(cat /Users/mariosiric/Documents/teams-modular-packages/tools/autodocs-engine/experiments/04-ab-comparison/.env 2>/dev/null | cut -d= -f2)

# Knip — MUST have NO React (deterministic tech stack)
mkdir -p /tmp/deterministic-test/knip
npx tsx src/bin/autodocs-engine.ts analyze /tmp/final-benchmark/knip/packages/knip \
  --root /tmp/final-benchmark/knip --format agents.md \
  --output /tmp/deterministic-test/knip --verbose
grep -i "react" /tmp/deterministic-test/knip/AGENTS.md && echo "FAIL" || echo "PASS: No React"
wc -w -l /tmp/deterministic-test/knip/AGENTS.md

# Sanity — MUST have NO jest.mock (deterministic conventions)
mkdir -p /tmp/deterministic-test/sanity
npx tsx src/bin/autodocs-engine.ts analyze /tmp/final-benchmark/sanity/packages/sanity \
  --root /tmp/final-benchmark/sanity --format agents.md \
  --output /tmp/deterministic-test/sanity --verbose
grep -i "jest.mock" /tmp/deterministic-test/sanity/AGENTS.md && echo "FAIL" || echo "PASS: No jest.mock"

# Backward compat — full LLM mode still works
npx tsx src/bin/autodocs-engine.ts analyze /tmp/final-benchmark/knip/packages/knip \
  --root /tmp/final-benchmark/knip --format agents.md --llm-synthesis full \
  --output /tmp/deterministic-test/knip-full --verbose
```

### Success Criteria
1. **Zero hallucinated technologies** in deterministic sections
2. **Architecture section** mentions only capabilities, no technology names
3. **Domain section** extracted from README if available
4. **All 249 existing tests pass**
5. **`--llm-synthesis full` produces same behavior as before**
6. **Output has real content** (not empty sections due to data gaps)

## What NOT to Change
- Don't modify the analysis pipeline (ast-parser, symbol-graph, etc.)
- Don't remove the existing full-LLM formatting code (keep as `--llm-synthesis full`)
- Don't change the serializer (it's still used for the full-LLM path and for JSON output)
- All 249 existing tests must pass

## What to Ask Me
- If a deterministic section looks too mechanical and needs LLM polish
- If the architecture micro-LLM call still hallucinates despite constraints
- If README extraction returns useless content (badges, links, etc.)
- If the output is too short because some packages have sparse analysis data
```
